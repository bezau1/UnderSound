<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Determination Soundboard</title>
  <style>
    /* Load Determination.ttf if placed next to this HTML */
    @font-face{
      font-family:"Determination";
      src:url("determination.ttf") format("truetype");
      font-display:swap;
    }

    :root{
      --bg:#000;
      --fg:#fff;
      --stroke:2px;
      --radius:14px;
      --gap:12px;
      --tile:86px; /* will be adjusted responsively */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: Determination, ui-monospace, "Courier New", monospace;
      letter-spacing: .2px;
      user-select:none;
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom: var(--stroke) solid var(--fg);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:18px;
      text-transform:uppercase;
    }

    .pill{
      padding:6px 10px;
      border: var(--stroke) solid var(--fg);
      border-radius:999px;
      background:#000;
      font-size:14px;
      opacity:.95;
      white-space:nowrap;
    }

    .iconBtn{
      width:38px;
      height:38px;
      display:grid;
      place-items:center;
      background:#000;
      border: var(--stroke) solid var(--fg);
      border-radius:10px;
      cursor:pointer;
      transition: transform .06s ease;
    }
    .iconBtn:active{ transform: translateY(1px) scale(.99); }
    .gear{
      width:18px;height:18px;
      display:block;
      border: var(--stroke) solid var(--fg);
      border-radius:50%;
      position:relative;
    }
    .gear:before,.gear:after{
      content:"";
      position:absolute;
      left:50%;top:50%;
      width:22px;height:2px;
      background:var(--fg);
      transform: translate(-50%,-50%) rotate(45deg);
    }
    .gear:after{ transform: translate(-50%,-50%) rotate(-45deg); }

    /* Grid */
    .wrap{
      height: calc(100% - 56px);
      display:flex;
      padding:14px;
    }
    .grid{
      width:100%;
      height:100%;
      display:grid;
      gap: var(--gap);
      align-content:start;
      justify-content:center;
      padding:6px;
      overflow:auto;
    }

    .tile{
      width:var(--tile);
      height:var(--tile);
      background:#000;
      border: var(--stroke) solid var(--fg);
      border-radius: var(--radius);
      display:grid;
      place-items:center;
      position:relative;
      cursor:pointer;
      overflow:hidden;
      transition: transform .06s ease;
    }
    .tile:active{ transform: translateY(1px) scale(.99); }

    /* default “icon” look */
    .glyph{
      width:42px;height:42px;
      border: var(--stroke) solid var(--fg);
      border-radius: 10px;
      background:#000;
      position:relative;
      opacity:.95;
    }
    .glyph:before{
      content:"";
      position:absolute;
      inset:10px;
      border: var(--stroke) solid var(--fg);
      border-radius: 6px;
    }

    .cover{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      filter: contrast(1.05);
      opacity:1;
    }
    .coverMask{
      position:absolute;
      inset:0;
      background: radial-gradient(transparent 40%, rgba(0,0,0,.35) 100%);
      pointer-events:none;
    }

    .slotNum{
      position:absolute;
      left:8px;
      bottom:6px;
      font-size:14px;
      background:#000;
      border: var(--stroke) solid var(--fg);
      border-radius:10px;
      padding:2px 6px;
      line-height:1.1;
      opacity:.9;
    }

    /* Context menu (hold) */
    .menu{
      position:fixed;
      z-index:50;
      min-width:220px;
      background:#000;
      border: var(--stroke) solid var(--fg);
      border-radius: 14px;
      padding:8px;
      display:none;
    }
    .menuHeader{
      font-size:14px;
      padding:6px 8px 8px;
      border-bottom: var(--stroke) solid var(--fg);
      margin-bottom:6px;
      opacity:.95;
    }
    .menuBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      margin:6px 0;
      border: var(--stroke) solid var(--fg);
      border-radius: 12px;
      background:#000;
      color:#fff;
      cursor:pointer;
      font-family:inherit;
      font-size:14px;
      text-transform:uppercase;
    }
    .menuBtn small{
      opacity:.8;
      font-size:12px;
      text-transform:none;
    }
    .menuBtn:active{ transform: translateY(1px); }

    /* Settings modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:80;
      padding:18px;
    }
    .modal{
      max-width:520px;
      margin: 0 auto;
      background:#000;
      border: var(--stroke) solid var(--fg);
      border-radius: 18px;
      padding:14px;
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: var(--stroke) solid var(--fg);
      padding-bottom:10px;
      margin-bottom:10px;
    }
    .modalTitle{
      font-size:18px;
      text-transform:uppercase;
    }
    .closeX{
      width:38px;height:38px;
      border: var(--stroke) solid var(--fg);
      border-radius:12px;
      background:#000;
      color:#fff;
      cursor:pointer;
      font-family:inherit;
      font-size:16px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:10px 0;
    }
    label{
      display:block;
      font-size:14px;
      text-transform:uppercase;
      opacity:.95;
      margin-bottom:6px;
    }
    input[type="number"]{
      width:100%;
      padding:10px 10px;
      background:#000;
      color:#fff;
      border: var(--stroke) solid var(--fg);
      border-radius: 12px;
      font-family:inherit;
      font-size:16px;
      outline:none;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    .bigBtn{
      flex:1;
      min-width:160px;
      padding:12px 12px;
      border: var(--stroke) solid var(--fg);
      border-radius: 14px;
      background:#000;
      color:#fff;
      cursor:pointer;
      font-family:inherit;
      font-size:14px;
      text-transform:uppercase;
    }
    .bigBtn:active{ transform: translateY(1px); }

    .hint{
      font-size:13px;
      opacity:.82;
      margin-top:10px;
      line-height:1.25;
    }

    /* Responsive tile sizing */
    @media (max-width: 520px){
      :root{ --tile:72px; --gap:10px; }
      .topbar{ padding:0 10px; }
      .brand{ font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="pill">SOUNDBOARD</div>
      <div class="pill" id="gridLabel">—</div>
    </div>
    <button class="iconBtn" id="openSettings" title="Settings">
      <span class="gear" aria-hidden="true"></span>
    </button>
  </div>

  <div class="wrap">
    <div class="grid" id="grid"></div>
  </div>

  <!-- Context menu -->
  <div class="menu" id="menu" role="dialog" aria-modal="true">
    <div class="menuHeader" id="menuHeader">SLOT</div>
    <button class="menuBtn" id="pickCoverBtn">
      CUSTOM PNG COVER <small>(optional)</small>
      <span>▸</span>
    </button>
    <button class="menuBtn" id="pickAudioBtn">
      SELECT MP3 <small>(required)</small>
      <span>▸</span>
    </button>
    <button class="menuBtn" id="clearSlotBtn">
      CLEAR SLOT
      <span>✕</span>
    </button>
  </div>

  <!-- Hidden file inputs -->
  <input id="coverInput" type="file" accept="image/png" hidden />
  <input id="audioInput" type="file" accept="audio/mpeg,audio/mp3" hidden />

  <!-- Settings modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle">SETTINGS</div>
        <button class="closeX" id="closeSettings" title="Close">X</button>
      </div>

      <div class="row">
        <div>
          <label for="rows">VERTICAL (ROWS)</label>
          <input type="number" id="rows" min="1" max="40" step="1" />
        </div>
        <div>
          <label for="cols">HORIZONTAL (COLUMNS)</label>
          <input type="number" id="cols" min="1" max="40" step="1" />
        </div>
      </div>

      <div class="actions">
        <button class="bigBtn" id="applyGrid">APPLY GRID</button>
        <button class="bigBtn" id="exportBtn">EXPORT (DOWNLOAD BACKUP)</button>
        <button class="bigBtn" id="importBtn">IMPORT (LOAD BACKUP)</button>
        <button class="bigBtn" id="resetBtn">RESET ALL</button>
      </div>

      <div class="hint">
        Hold (long-press) a button to assign a PNG cover + MP3. Right-click also works on desktop.<br/>
        Export/Import saves layout + covers + slot names. Browsers may require re-selecting MP3 files after import.
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "det_soundboard_v1";

    const gridEl = document.getElementById("grid");
    const gridLabel = document.getElementById("gridLabel");

    const overlay = document.getElementById("overlay");
    const openSettings = document.getElementById("openSettings");
    const closeSettings = document.getElementById("closeSettings");

    const rowsInput = document.getElementById("rows");
    const colsInput = document.getElementById("cols");
    const applyGridBtn = document.getElementById("applyGrid");

    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const resetBtn = document.getElementById("resetBtn");

    const menu = document.getElementById("menu");
    const menuHeader = document.getElementById("menuHeader");
    const pickCoverBtn = document.getElementById("pickCoverBtn");
    const pickAudioBtn = document.getElementById("pickAudioBtn");
    const clearSlotBtn = document.getElementById("clearSlotBtn");

    const coverInput = document.getElementById("coverInput");
    const audioInput = document.getElementById("audioInput");

    // In-memory audio objects (won't survive refresh)
    const audioObjects = new Map(); // slotIndex -> HTMLAudioElement

    let state = loadState();
    let activeSlot = null;

    function defaultState(){
      return {
        rows: 4,
        cols: 4,
        slots: [] // length = rows*cols ; each: { coverDataUrl, audioName }
      };
    }

    function ensureSlots(){
      const total = state.rows * state.cols;
      if (!Array.isArray(state.slots)) state.slots = [];
      while (state.slots.length < total) state.slots.push({ coverDataUrl: null, audioName: null });
      if (state.slots.length > total) state.slots = state.slots.slice(0, total);

      // also cleanup dangling audio objects
      for (const key of Array.from(audioObjects.keys())) {
        if (key >= total) audioObjects.delete(key);
      }
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);
        const s = { ...defaultState(), ...parsed };
        return s;
      }catch{
        return defaultState();
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        rows: state.rows,
        cols: state.cols,
        slots: state.slots
      }));
    }

    function updateGridLabel(){
      gridLabel.textContent = `${state.rows}×${state.cols}`;
    }

    function render(){
      ensureSlots();
      updateGridLabel();

      // Responsive tile size: fit columns nicely
      const padding = 14 * 2 + 12; // approx body padding + scroll
      const availableW = Math.max(320, window.innerWidth - padding);
      const gap = 12;
      const tile = Math.floor((availableW - (state.cols - 1) * gap) / state.cols);
      const clamped = Math.max(64, Math.min(tile, 120));
      document.documentElement.style.setProperty("--tile", clamped + "px");

      gridEl.style.gridTemplateColumns = `repeat(${state.cols}, var(--tile))`;
      gridEl.style.gridTemplateRows = `repeat(${state.rows}, var(--tile))`;

      gridEl.innerHTML = "";
      const total = state.rows * state.cols;

      for(let i=0;i<total;i++){
        const slot = state.slots[i];

        const tileEl = document.createElement("div");
        tileEl.className = "tile";
        tileEl.dataset.index = String(i);

        // cover
        if(slot.coverDataUrl){
          const img = document.createElement("img");
          img.className = "cover";
          img.src = slot.coverDataUrl;
          img.alt = "";
          tileEl.appendChild(img);

          const mask = document.createElement("div");
          mask.className = "coverMask";
          tileEl.appendChild(mask);
        } else {
          const glyph = document.createElement("div");
          glyph.className = "glyph";
          tileEl.appendChild(glyph);
        }

        const n = document.createElement("div");
        n.className = "slotNum";
        n.textContent = String(i+1);
        tileEl.appendChild(n);

        // Tap = play (if loaded)
        tileEl.addEventListener("click", (e) => {
          // if menu is open and clicking same slot, ignore play
          if (menu.style.display === "block") return;
          playSlot(i);
        });

        // Right click = menu
        tileEl.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          openMenuForSlot(i, e.clientX, e.clientY);
        });

        // Long press (touch / mouse)
        attachLongPress(tileEl, (x,y) => openMenuForSlot(i, x, y));

        gridEl.appendChild(tileEl);
      }
    }

    function attachLongPress(el, cb){
      let timer = null;
      let startX=0, startY=0;
      const threshold = 8;

      const clear = () => { if(timer){ clearTimeout(timer); timer=null; } };

      el.addEventListener("pointerdown", (e) => {
        // allow touch + mouse
        startX = e.clientX; startY = e.clientY;
        clear();
        timer = setTimeout(() => {
          cb(e.clientX, e.clientY);
          clear();
        }, 420);
      });

      el.addEventListener("pointermove", (e) => {
        if(!timer) return;
        if(Math.abs(e.clientX-startX) > threshold || Math.abs(e.clientY-startY) > threshold){
          clear();
        }
      });

      el.addEventListener("pointerup", clear);
      el.addEventListener("pointercancel", clear);
      el.addEventListener("pointerleave", clear);
    }

    function playSlot(index){
      const audio = audioObjects.get(index);
      if(!audio){
        // tiny “nope” feel: flash border
        const tile = gridEl.querySelector(`[data-index="${index}"]`);
        if(tile){
          tile.style.transform = "scale(0.98)";
          setTimeout(()=> tile.style.transform="", 80);
        }
        return;
      }
      audio.currentTime = 0;
      audio.play().catch(()=>{});
    }

    function openMenuForSlot(index, x, y){
      activeSlot = index;
      const slot = state.slots[index];
      const name = slot.audioName ? slot.audioName : "EMPTY";
      menuHeader.textContent = `SLOT ${index+1} — ${name}`;

      menu.style.display = "block";

      // position menu inside viewport
      const pad = 10;
      const rect = menu.getBoundingClientRect();
      let left = x;
      let top = y;

      // measure after display
      const w = menu.offsetWidth;
      const h = menu.offsetHeight;

      if(left + w + pad > window.innerWidth) left = window.innerWidth - w - pad;
      if(top + h + pad > window.innerHeight) top = window.innerHeight - h - pad;
      if(left < pad) left = pad;
      if(top < 56 + pad) top = 56 + pad;

      menu.style.left = left + "px";
      menu.style.top = top + "px";
    }

    function closeMenu(){
      menu.style.display = "none";
      activeSlot = null;
    }

    // Close menu on outside click
    window.addEventListener("pointerdown", (e) => {
      if(menu.style.display !== "block") return;
      const isMenu = e.target === menu || menu.contains(e.target);
      if(!isMenu){
        closeMenu();
      }
    });

    // Esc closes modals/menus
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        closeMenu();
        closeSettingsModal();
      }
    });

    pickCoverBtn.addEventListener("click", () => {
      if(activeSlot == null) return;
      coverInput.value = "";
      coverInput.click();
    });

    pickAudioBtn.addEventListener("click", () => {
      if(activeSlot == null) return;
      audioInput.value = "";
      audioInput.click();
    });

    clearSlotBtn.addEventListener("click", () => {
      if(activeSlot == null) return;
      state.slots[activeSlot] = { coverDataUrl: null, audioName: null };
      audioObjects.delete(activeSlot);
      saveState();
      render();
      closeMenu();
    });

    coverInput.addEventListener("change", async () => {
      if(activeSlot == null) return;
      const file = coverInput.files?.[0];
      if(!file) return;

      // store as DataURL (PNG)
      const dataUrl = await fileToDataURL(file);
      state.slots[activeSlot].coverDataUrl = dataUrl;
      saveState();
      render();
      closeMenu();
    });

    audioInput.addEventListener("change", () => {
      if(activeSlot == null) return;
      const file = audioInput.files?.[0];
      if(!file) return;

      const url = URL.createObjectURL(file);
      const audio = new Audio(url);
      audioObjects.set(activeSlot, audio);

      state.slots[activeSlot].audioName = file.name;
      saveState();
      render();
      closeMenu();
    });

    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // Settings modal
    openSettings.addEventListener("click", () => openSettingsModal());
    closeSettings.addEventListener("click", () => closeSettingsModal());

    function openSettingsModal(){
      rowsInput.value = state.rows;
      colsInput.value = state.cols;
      overlay.style.display = "block";
    }
    function closeSettingsModal(){
      overlay.style.display = "none";
    }

    overlay.addEventListener("pointerdown", (e) => {
      if(e.target === overlay) closeSettingsModal();
    });

    applyGridBtn.addEventListener("click", () => {
      const r = clamp(parseInt(rowsInput.value,10) || 1, 1, 40);
      const c = clamp(parseInt(colsInput.value,10) || 1, 1, 40);

      state.rows = r;
      state.cols = c;
      ensureSlots();
      saveState();
      render();
      closeSettingsModal();
    });

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    // Export / Import
    exportBtn.addEventListener("click", () => {
      const backup = {
        version: 1,
        exportedAt: new Date().toISOString(),
        rows: state.rows,
        cols: state.cols,
        slots: state.slots
        // Note: audio files themselves can't be packed reliably without user re-providing them.
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "determination-soundboard-backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    importBtn.addEventListener("click", async () => {
      const file = await pickJsonFile();
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || typeof data !== "object") throw new Error("Invalid file");
        if(!("rows" in data) || !("cols" in data) || !Array.isArray(data.slots)) throw new Error("Missing fields");

        state.rows = clamp(parseInt(data.rows,10) || 1, 1, 40);
        state.cols = clamp(parseInt(data.cols,10) || 1, 1, 40);

        // sanitize slots
        const total = state.rows * state.cols;
        state.slots = [];
        for(let i=0;i<total;i++){
          const s = data.slots[i] || {};
          state.slots.push({
            coverDataUrl: typeof s.coverDataUrl === "string" ? s.coverDataUrl : null,
            audioName: typeof s.audioName === "string" ? s.audioName : null
          });
        }

        audioObjects.clear(); // audio must be reselected
        saveState();
        render();
        closeSettingsModal();
        alert("Imported! Note: you may need to re-select MP3 files for each slot.");
      }catch(err){
        alert("Import failed: " + (err?.message || "Unknown error"));
      }
    });

    function pickJsonFile(){
      return new Promise((resolve) => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "application/json";
        input.onchange = () => resolve(input.files?.[0] || null);
        input.click();
      });
    }

    resetBtn.addEventListener("click", () => {
      const ok = confirm("Reset everything? This clears layout, covers, and saved slot names.");
      if(!ok) return;
      state = defaultState();
      audioObjects.clear();
      saveState();
      render();
      closeSettingsModal();
    });

    // Re-render on resize
    window.addEventListener("resize", () => render());

    // Initial
    ensureSlots();
    saveState();
    render();
  </script>
</body>
</html>
